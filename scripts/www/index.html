<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å…¬å¯“ç®¡ç†ç³»ç»Ÿ - å‡çº§ç‰ˆ</title>

    <link rel="stylesheet" href="//unpkg.com/element-plus/dist/index.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* ========== æ ·å¼éƒ¨åˆ† ========== */
        :root {
            --primary: #2563eb;
            --primary-bg: #eff6ff;
            --text-main: #1f2937;
            --text-gray: #6b7280;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --border: #e5e7eb;
            --radius: 12px;
            --nav-height: 60px;
            --spacing-page: 24px;
        }

        @media (max-width: 768px) {
            :root {
                --spacing-page: 16px;
            }
        }

        body {
            margin: 0;
            padding-bottom: calc(var(--nav-height) + env(safe-area-inset-bottom) + 20px);
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .page-container,
        .book-page,
        .analysis-page {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-page);
        }

        /* åº•éƒ¨å¯¼èˆª */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background: #fff;
            border-top: 1px solid var(--border);
            display: flex;
            z-index: 999;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.03);
        }

        .tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 11px;
            gap: 4px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .tab-item.active {
            color: var(--primary);
            font-weight: 600;
        }

        .tab-item .el-icon {
            font-size: 22px;
            margin-bottom: 0;
        }

        /* å¡ç‰‡é€šç”¨ */
        .el-card {
            border-radius: var(--radius) !important;
            border: 1px solid var(--border) !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05) !important;
            background: var(--bg-card);
        }

        .el-card__header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        h2 {
            margin: 0;
            font-size: 22px;
            color: #111827;
        }

        .subtitle {
            margin-top: 4px;
            color: var(--text-gray);
            font-size: 13px;
        }

        /* æ—¥å†æ ·å¼ä¿®æ”¹é‡ç‚¹åŒºåŸŸ */
        .custom-calendar .el-calendar {
            --el-calendar-border: none;
            background: transparent;
        }

        .custom-calendar .el-calendar__header {
            padding: 0 0 16px 0;
            border: none;
        }

        .custom-calendar .el-calendar__body {
            padding: 0;
        }

        .custom-calendar .el-calendar-table {
            border: none;
        }

        .custom-calendar .el-calendar-table td {
            border: none;
            padding: 4px;
        }

        .custom-calendar .el-calendar-table .el-calendar-day {
            height: 48px;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .custom-calendar .el-calendar-table td:hover {
            background-color: transparent;
        }

        /* æ—¥æœŸå•å…ƒæ ¼æ ·å¼ */
        .date-cell {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            /* åœ†å½¢ */
            font-size: 14px;
            font-weight: 500;
            position: relative;
            transition: all 0.2s;
            cursor: pointer;
            color: var(--text-main);
            border: 2px solid transparent;
            /* é¢„ç•™è¾¹æ¡†ä½ç½®é˜²æ­¢æŠ–åŠ¨ */
        }

        /* ä»Šå¤©ï¼šç©ºå¿ƒè“åœˆï¼Œæˆ–è€…æ·¡è“è‰²èƒŒæ™¯ï¼Œè¿™é‡Œæ ¹æ®ä¹ æƒ¯æ”¹ä¸ºæ·¡è“ï¼Œä»¥åŒºåˆ†â€œé€‰ä¸­â€ */
        .date-cell.is-today {
            color: var(--primary);
            font-weight: 700;
            background: #eff6ff;
            /* æ·¡è“èƒŒæ™¯ */
        }

        /* æ ¸å¿ƒä¿®æ”¹ï¼šé€‰ä¸­çŠ¶æ€æ”¹ä¸ºå®å¿ƒè“åœ†ç‚¹æ ·å¼ */
        .date-cell.is-multi-selected {
            background-color: var(--primary) !important;
            color: #fff !important;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.4);
            transform: scale(1.05);
        }

        /* æ•°æ®æŒ‡ç¤ºç‚¹ï¼ˆå¦‚æœæœ‰è´¦å•ï¼‰ */
        .data-dot {
            width: 4px;
            height: 4px;
            background-color: var(--primary);
            border-radius: 50%;
            position: absolute;
            bottom: -6px;
        }

        /* å¦‚æœé€‰ä¸­äº†ï¼Œä¸‹é¢çš„å°ç‚¹å˜ç™½ï¼Œå¦åˆ™çœ‹ä¸æ¸… */
        .date-cell.is-multi-selected+.data-dot {
            background-color: #fff;
            bottom: 4px;
        }

        .date-cell.is-today:not(.is-multi-selected)+.data-dot {
            bottom: 2px;
        }

        @media (max-width: 768px) {
            .el-col {
                width: 100% !important;
                max-width: 100% !important;
                flex: 0 0 100% !important;
                margin-bottom: 16px;
            }

            .custom-calendar .el-calendar-table .el-calendar-day {
                height: 40px;
            }

            .date-cell {
                width: 32px;
                height: 32px;
                font-size: 13px;
            }
        }
    </style>
</head>

<body>

    <div id="app">
        <router-view></router-view>
        <div class="tab-bar" v-if="showTabBar">
            <div v-for="t in tabs" :key="t.key" :class="['tab-item', { active: activeTab === t.key }]"
                @click="switchTab(t)">
                <el-icon>
                    <component :is="t.icon" />
                </el-icon>
                <span>{{ t.title }}</span>
            </div>
        </div>
    </div>

    <!-- <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <script src="https://unpkg.com/element-plus/dist/locale/zh-cn.js"></script>
    <script src="https://unpkg.com/dayjs/dayjs.min.js"></script> -->
    <script src="./vue.global.js"></script>
    <script src="./vue-router.global.js"></script>
    <script src="./axios.min.js"></script>
    <script src="./dayjs.min.js"></script>
    <link rel="stylesheet" href="./index.css" />
    <!-- Element-Plus ä¸»åŒ… + ä¸­æ–‡è¯­è¨€åŒ… + å›¾æ ‡ -->
    <script src="./element-plus-2.13.0-dist-index.full.js.js"></script>
    <script src="./element-plus-2.13.0-dist-locale-zh-cn.js"></script>
    <script src="./element-plus-icons-vue@2.3.2.js"></script>
    <script type="text/x-template" id="tmpl-login">
        <div class="login-wrapper">
            <div class="login-box">
                <div class="brand">
                    <div class="logo">ğŸ </div>
                    <div>
                        <h2 style="margin:0; color:#111827;">å…¬å¯“ç®¡å®¶</h2>
                        <p style="margin:4px 0 0; color:#6b7280; font-size:13px;">è¯·ç™»å½•ä»¥ç®¡ç†æ‚¨çš„æˆ¿æº</p>
                    </div>
                </div>
                <el-form class="login-form" size="large">
                    <el-form-item><el-input v-model="form.username" placeholder="è´¦å·" :prefix-icon="User" /></el-form-item>
                    <el-form-item><el-input v-model="form.password" type="password" placeholder="å¯†ç " :prefix-icon="Lock" show-password @keyup.enter="handleLogin"/></el-form-item>
                    <el-button type="primary" class="login-btn" :loading="loading" @click="handleLogin">ç™» å½•</el-button>
                </el-form>
                <div class="footer">Â© 2025 Apartment System</div>
            </div>
        </div>
    </script>
    <style>
        .login-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .login-box {
            width: 90%;
            max-width: 360px;
            background: #fff;
            padding: 32px 24px;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
        }

        .brand {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-bottom: 32px;
        }

        .logo {
            width: 48px;
            height: 48px;
            background: var(--primary-bg);
            color: var(--primary);
            border-radius: 12px;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-btn {
            width: 100%;
            font-weight: 600;
            padding: 20px 0;
            border-radius: 8px;
        }

        .footer {
            text-align: center;
            margin-top: 24px;
            font-size: 12px;
            color: #d1d5db;
        }
    </style>

    <script type="text/x-template" id="tmpl-orderbook">
        <div class="book-page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <div>
                    <h2>å…¥ä½è®°è´¦</h2>
                    <p class="subtitle">{{ dateStr }}</p>
                </div>
                
                <div style="display:flex; gap:8px;">
                    <el-button type="warning" :icon="Files" @click="openBatchDialog" round>æ‰¹é‡è®°è´¦</el-button>
                    <el-button circle :icon="Plus" type="primary" class="hidden-md-and-up" @click="scrollToForm"></el-button>
                </div>
            </div>

            <el-row :gutter="20">
                <el-col :md="14" :xs="24">
                    <el-card shadow="never" class="custom-calendar" :body-style="{ padding: '10px' }">
                        <el-calendar v-model="selectedDate" @update:model-value="handleDateChange">
                            <template #date-cell="{ data }">
                                <div class="date-cell" :class="{ 'is-today': data.day === todayStr, 'is-selected': data.day === dateStr }">
                                    {{ data.day.split('-').pop() }}
                                </div>
                                <div v-if="hasBill(data.day)" class="data-dot"></div>
                            </template>
                        </el-calendar>
                    </el-card>
                </el-col>

                <el-col :md="10" :xs="24" id="form-section">
                    <el-card shadow="never" class="mb-4">
                        <template #header>
                            <span>{{ isEdit ? 'ç¼–è¾‘è´¦å•' : 'è®°ä¸€ç¬” (å•å¤©)' }}</span>
                            <el-tag size="small" class="ml-2">{{ dateStr }}</el-tag>
                        </template>
                        
                        <div style="display:flex; flex-direction:column; gap:16px;">
                            <div>
                                <div class="label-text">æˆ¿é—´</div>
                                <div style="display:flex; gap:8px;">
                                    <el-select v-model="roomId" placeholder="é€‰æ‹©æˆ¿é—´" style="flex:1"  :clearable="false">
                                        <el-option v-for="r in roomList" :key="r.id" :label="r.name" :value="r.name" />
                                    </el-select>
                                    <el-button :icon="Setting" @click="openRoomManager" plain></el-button>
                                </div>
                            </div>
                            
                            <div>
                                <div class="label-text">é‡‘é¢</div>
                                <el-input-number v-model="roomPrice" :min="0" :step="10" style="width: 100%" size="large" />
                            </div>

                            <el-button type="primary" size="large" @click="submitBill" style="margin-top:8px; font-weight:600;">
                                {{ isEdit ? 'ä¿ å­˜' : 'ç¡® è®¤' }}
                            </el-button>
                            <el-button v-if="isEdit" @click="cancelEdit" size="default" link>å–æ¶ˆç¼–è¾‘</el-button>
                        </div>
                    </el-card>

                    <el-card shadow="never">
                        <div style="font-weight:600; margin-bottom:12px; font-size:14px;">{{ dateStr }} æ˜ç»†</div>
                        <el-table :data="bills" :show-header="false" style="width: 100%" empty-text="å½“æ—¥æš‚æ— è´¦å•">
                            <el-table-column prop="roomName"><template #default="{ row }"><span style="font-weight:500;">{{ row.roomName }}</span></template></el-table-column>
                            <el-table-column prop="sales" align="right"><template #default="{ row }"><span style="font-weight:600; color:var(--primary);">Â¥{{ row.sales }}</span></template></el-table-column>
                            <el-table-column width="80" align="right">
                                <template #default="{ row }">
                                    <el-button link type="primary" size="small" @click="editBill(row)">æ”¹</el-button>
                                    <el-button link type="danger" size="small" @click="handleRemove(row.id)">åˆ </el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </el-card>
                </el-col>
            </el-row>

            <el-drawer v-model="showBatchDialog" title="æ‰¹é‡è®°è´¦" direction="btt" size="85%" :with-header="false" destroy-on-close>
                <div style="padding: 20px 0;">
                    <h3 style="margin-top:0;">âš¡ï¸ æ‰¹é‡æé€Ÿè®°è´¦</h3>
                    
                    <el-form label-position="top" size="large">
                        <el-form-item label="é€‰æ‹©æˆ¿é—´">
                            <el-select v-model="roomId" placeholder="é€‰æ‹©æˆ¿é—´" style="width:100%" filterable>
                                <el-option v-for="r in roomList" :key="r.id" :label="r.name" :value="r.name" />
                            </el-select>
                        </el-form-item>

                        <el-form-item label="é€‰æ‹©æ—¥æœŸæ¨¡å¼">
                            <el-radio-group v-model="batchMode" size="default">
                                <el-radio-button label="dates">å¤šä¸ªæ—¥æœŸ (ç‚¹é€‰)</el-radio-button>
                                <el-radio-button label="range">è¿ç»­èŒƒå›´ (èµ·æ­¢)</el-radio-button>
                            </el-radio-group>
                        </el-form-item>

                        <el-form-item label="é€‰æ‹©æ—¥æœŸ">
                            <el-date-picker 
                                v-if="batchMode === 'dates'"
                                v-model="batchDates" 
                                type="dates" 
                                placeholder="ç‚¹å‡»é€‰æ‹©å¤šä¸ªæ—¥æœŸ" 
                                format="YYYY-MM-DD"
                                value-format="YYYY-MM-DD"
                                style="width: 100%" 
                            />
                            <el-date-picker 
                                v-else
                                v-model="batchRange" 
                                type="daterange" 
                                start-placeholder="å¼€å§‹æ—¥æœŸ" 
                                end-placeholder="ç»“æŸæ—¥æœŸ" 
                                value-format="YYYY-MM-DD"
                                style="width: 100%" 
                            />
                        </el-form-item>

                        <el-form-item label="å•æ—¥é‡‘é¢">
                            <el-input-number v-model="roomPrice" :min="0" :step="10" style="width: 100%" />
                        </el-form-item>
                    </el-form>

                    <div style="background:#f9fafb; padding:12px; border-radius:8px; margin-bottom:20px;" v-if="batchCount > 0">
                        <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                            <span style="color:#6b7280;">å·²é€‰å¤©æ•°</span>
                            <span style="font-weight:600;">{{ batchCount }} å¤©</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; font-size:16px;">
                            <span style="color:#6b7280;">é¢„è®¡æ€»é¢</span>
                            <span style="color:var(--primary); font-weight:700;">Â¥ {{ batchCount * roomPrice }}</span>
                        </div>
                    </div>

                    <el-button type="primary" size="large" style="width:100%; height:48px; font-size:16px;" @click="submitBatch" :disabled="batchCount===0" :loading="submitting">
                        ç¡®è®¤è®°è´¦ ({{ batchCount }}ç¬”)
                    </el-button>
                </div>
            </el-drawer>

            <el-dialog v-model="showRoomManager" title="æˆ¿é—´ç®¡ç†" width="90%" style="max-width:400px;" align-center>
                <el-input v-model="newRoomName" placeholder="è¾“å…¥æˆ¿å· (å¦‚: 101)" size="large" class="mb-4" @keyup.enter="handleAddNewRoom">
                    <template #append><el-button @click="handleAddNewRoom">æ·»åŠ </el-button></template>
                </el-input>
                <div style="display:flex; flex-wrap:wrap; gap:8px; max-height:300px; overflow-y:auto;">
                    <el-tag v-for="room in roomList" :key="room.id" closable size="large" type="info" @close="handleDeleteRoom(room)">{{ room.name }}</el-tag>
                </div>
            </el-dialog>
        </div>
    </script>

    <style>
        /* è¡¥å……æ ·å¼ */
        .label-text {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 6px;
        }

        .is-selected {
            background-color: #eff6ff;
            color: var(--primary);
            font-weight: 700;
            border: 1px solid var(--primary);
        }
    </style>

    <script type="text/x-template" id="tmpl-analysis">
        <div class="analysis-page">
            <div style="display:flex; justify-content:space-between; align-items:end; margin-bottom:20px;">
                <div><h2>æ•°æ®åˆ†æ</h2><p class="subtitle">è¥æ”¶ä¸å…¥ä½è¶‹åŠ¿</p></div>
                <el-date-picker v-model="selectedMonth" type="month" placeholder="æœˆä»½" :clearable="false" @change="loadData" style="width: 110px;" :editable="false" size="small" value-format="YYYY-MM"/>
            </div>
            <el-card shadow="never" class="mb-4" style="background: linear-gradient(135deg, #fff, #f0f7ff);">
                <div style="display:flex; align-items:center; gap:16px;">
                    <div class="icon-box-lg" style="background:rgba(37,99,235,0.1); color:var(--primary); padding:12px; border-radius:12px;"><el-icon size="28"><Money /></el-icon></div>
                    <div><div style="font-size:13px; color:#6b7280;">æœ¬æœˆæ€»è¥æ”¶</div><div class="sales-number" style="font-size:28px; font-weight:700; line-height:1.2;"><span style="font-size:16px;">Â¥</span>{{ totalSales.toLocaleString() }}</div></div>
                </div>
            </el-card>
            <el-row :gutter="20">
                <el-col :md="12" :xs="24">
                    <el-card shadow="never" class="mb-4">
                        <div slot="header" style="font-weight:600; margin-bottom:12px;">æˆ¿é—´æ’è¡Œ</div>
                        <el-table :data="roomSales" stripe :show-header="false" empty-text="æš‚æ— æ•°æ®"><el-table-column prop="room_name" /><el-table-column prop="total" align="right"><template #default="{row}"><b style="color:var(--text-main)">Â¥{{row.total}}</b></template></el-table-column></el-table>
                    </el-card>
                </el-col>
                <el-col :md="12" :xs="24">
                    <el-card shadow="never">
                        <div slot="header" style="font-weight:600; margin-bottom:12px;">å…¥ä½ç‡ ({{daysInMonth}}å¤©)</div>
                        <div v-if="!roomSalesCount.length" style="text-align:center; padding:20px; color:#999;">æš‚æ— æ•°æ®</div>
                        <div v-for="item in roomSalesCount" :key="item.room_name" style="margin-bottom:16px;">
                            <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px;"><span>{{ item.room_name }}</span><span style="color:#6b7280;">{{ item.billCnt }}å¤© / {{ getProgressPercentage(item.billCnt) }}%</span></div>
                            <el-progress :percentage="getProgressPercentage(item.billCnt)" :color="getProgressColor(item.billCnt)" :show-text="false" :stroke-width="8" />
                        </div>
                    </el-card>
                </el-col>
            </el-row>
        </div>
    </script>

    <script type="text/x-template" id="tmpl-mine">
        <div class="page-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0;">æˆ‘çš„æ¦‚è§ˆ</h2>
                <el-date-picker 
                    v-model="selectedMonth" 
                    type="month" 
                    placeholder="é€‰æ‹©æœˆä»½" 
                    :clearable="false" 
                    :editable="false" 
                    size="default" 
                    style="width: 120px;" 
                    value-format="YYYY-MM"
                    @change="load"
                />
            </div>
            
            <div style="background:var(--primary); color:#fff; border-radius:var(--radius); padding:24px; margin-bottom:20px; display:flex; align-items:center;">
                <div style="flex:1;">
                    <div style="opacity:0.8; font-size:13px; margin-bottom:4px;">{{ selectedMonth }} æ€»è¥æ”¶</div>
                    <div style="font-size:32px; font-weight:700;">Â¥ {{ monthTotalSales || 0 }}</div>
                </div>
                <div style="background:rgba(255,255,255,0.2); width:48px; height:48px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                    <el-icon size="24"><Wallet /></el-icon>
                </div>
            </div>

            <el-card shadow="never" class="mb-4">
                <template #header>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span>è´¦å•æ˜ç»†</span>
                        <el-tag size="small" type="info">{{ monthlyOrders.length }} ç¬”</el-tag>
                    </div>
                </template>
                
                <el-table :data="monthlyOrders" height="400" style="width: 100%" empty-text="æœ¬æœˆæš‚æ— æ•°æ®" stripe>
                    <el-table-column prop="date" label="æ—¥æœŸ" width="110">
                         <template #default="{row}">
                            <span style="color:#6b7280; font-size:13px; font-family:monospace;">{{row.date}}</span>
                         </template>
                    </el-table-column>
                    
                    <el-table-column prop="roomName" label="æˆ¿å·">
                        <template #default="{row}">
                            <span style="font-weight:500;">{{row.roomName}}</span>
                        </template>
                    </el-table-column>
                    
                    <el-table-column prop="sales" align="right" label="é‡‘é¢">
                         <template #default="{row}">
                            <b style="color:var(--primary)">+{{row.sales}}</b>
                        </template>
                    </el-table-column>
                </el-table>
            </el-card>
            <br>
            <el-button type="danger" plain style="width:100%" @click="logout">é€€å‡ºç™»å½•</el-button>
        </div>
    </script>

    <script>
        const { createApp, ref, reactive, computed, onMounted, defineComponent } = Vue;
        const { createRouter, createWebHashHistory, useRouter, useRoute } = VueRouter;
        const { ElMessage, ElNotification, ElMessageBox } = ElementPlus;
        const { User, Lock, Plus, Setting, Money, Wallet, DataLine, Calendar, House } = ElementPlusIconsVue;

        // ========== æœ¬åœ°å­˜å‚¨ ==========
        const nativeStorage = {
            getItem: (k) => { try { return JSON.parse(localStorage.getItem(k)) } catch (e) { return localStorage.getItem(k) } },
            setItem: (k, v) => localStorage.setItem(k, typeof v === 'object' ? JSON.stringify(v) : v),
            removeItem: (k) => localStorage.removeItem(k),
            clear: () => localStorage.clear()
        };

        // ========== Axios (ä¿æŒåŸæ ·) ==========
        const request = axios.create({ baseURL: 'http://113.44.173.24:8080/api', timeout: 3000 });
        request.interceptors.request.use(config => {
            const token = nativeStorage.getItem('token');
            if (token) config.headers.token = token;
            return config;
        });
        request.interceptors.response.use(
            res => res.data,
            err => {
                if (err.response?.status === 401) {
                    ElMessage.error('ç™»å½•å·²è¿‡æœŸ'); localStorage.clear(); location.reload();
                }
                return Promise.reject(err);
            }
        );

        // ========== API (ä¿æŒåŸæ ·) ==========
        const api = {
            login: (data) => request.post('/login', data),
            getBillsByDate: (date) => request.get(`/bill/selectDate/${date}`),
            addBill: (data) => request.post('/bill/setBill', data),
            editBill: (data) => request.post('/bill/editBill', data),
            deleteBill: (id) => request.delete(`/bill/deleteBill/${id}`),
            roomList: () => request.get('/room/list'),
            addRoom: (roomName) => request.post('/room/add', { roomName }),
            deleteRoom: (id) => request.delete(`/room/delete/${id}`),
            getMonthTotalSales: (ym) => request.get(`/analysis/monthTotalSales/${ym}`),
            getMonthEveryTotalSales: (ym) => request.get(`/analysis/monthEveryTotalSales/${ym}`),
            getSalesInMonth: (ym) => request.get(`/analysis/salesInMonth/${ym}`),
            selectAllBills: () => request.get('/bill/selectAll')
        };

        // ========== ç»„ä»¶ ==========

        const LoginComponent = defineComponent({
            template: '#tmpl-login',
            setup() {
                const form = reactive({ username: '', password: '' });
                const loading = ref(false);
                const router = useRouter();
                const handleLogin = async () => {
                    if (!form.username || !form.password) return ElMessage.warning('è¯·è¾“å…¥è´¦å·å¯†ç ');
                    loading.value = true;
                    try {
                        const res = await api.login(form);
                        if (res.code === 200 && res.data?.token) {
                            nativeStorage.setItem('token', res.data.token);
                            ElNotification.success('ç™»å½•æˆåŠŸ'); router.replace('/');
                        } else { ElMessage.error(res.message || 'ç™»å½•å¤±è´¥'); }
                    } catch (e) { ElMessage.error(e.message || 'ç½‘ç»œå¼‚å¸¸'); } finally { loading.value = false; }
                }
                return { form, loading, handleLogin, User, Lock };
            }
        });

        // --- OrderBook Component ---
        const OrderBook = defineComponent({
            template: '#tmpl-orderbook',
            setup() {
                const { Files } = ElementPlusIconsVue; // å¼•å…¥æ–°å›¾æ ‡

                // --- åŸºç¡€çŠ¶æ€ ---
                const selectedDate = ref(new Date()); // å½“å‰æŸ¥çœ‹çš„æ—¥æœŸå¯¹è±¡
                const bills = ref([]);
                const roomList = ref(nativeStorage.getItem('my_room_list') || []);
                const roomId = ref('');
                const roomPrice = ref(80);

                // --- ç¼–è¾‘ä¸å•æ¡çŠ¶æ€ ---
                const isEdit = ref(false);
                const editId = ref(null);
                const submitting = ref(false);

                // --- æ‰¹é‡è®°è´¦çŠ¶æ€ (æ–°) ---
                const showBatchDialog = ref(false);
                const batchMode = ref('dates'); // 'dates' (å¤šç‚¹) æˆ– 'range' (èŒƒå›´)
                const batchDates = ref([]);     // å­˜å‚¨å¤šç‚¹æ—¥æœŸæ•°ç»„
                const batchRange = ref([]);     // å­˜å‚¨èŒƒå›´æ—¥æœŸ [start, end]

                // --- è¾…åŠ©è®¡ç®— ---
                const pad = n => n.toString().padStart(2, '0');
                // dateStr ç”¨äºå•æ—¥è®°è´¦å’Œå±•ç¤ºåˆ—è¡¨
                const dateStr = computed(() => `${selectedDate.value.getFullYear()}-${pad(selectedDate.value.getMonth() + 1)}-${pad(selectedDate.value.getDate())}`);
                const todayStr = `${new Date().getFullYear()}-${pad(new Date().getMonth() + 1)}-${pad(new Date().getDate())}`;

                // è®¡ç®—æ‰¹é‡é€‰ä¸­çš„å¤©æ•°
                const batchCount = computed(() => {
                    if (batchMode.value === 'dates') return batchDates.value ? batchDates.value.length : 0;
                    if (batchMode.value === 'range' && batchRange.value && batchRange.value.length === 2) {
                        const start = dayjs(batchRange.value[0]);
                        const end = dayjs(batchRange.value[1]);
                        return end.diff(start, 'day') + 1;
                    }
                    return 0;
                });

                // --- æ–¹æ³• ---

                const handleDateChange = () => {
                    // æ—¥å†åˆ‡æ¢æ—¶ï¼Œé‡ç½®ç¼–è¾‘çŠ¶æ€ï¼ŒåŠ è½½æ–°æ—¥æœŸæ•°æ®
                    isEdit.value = false;
                    editId.value = null;
                    loadBills();
                }

                const loadRooms = async () => {
                    try {
                        const res = await api.roomList();
                        if (res.code === 200) {
                            roomList.value = (res.data || []).map(r => ({ id: r.id, name: r.room_name || r.roomName || r.name }));
                            nativeStorage.setItem('my_room_list', roomList.value);
                        }
                    } catch (e) { }
                };

                const loadBills = async () => {
                    try {
                        const res = await api.getBillsByDate(dateStr.value);
                        bills.value = res.data || [];
                    } catch (e) { }
                };

                const hasBill = (day) => {
                    if (day === dateStr.value && bills.value.length > 0) return true;
                    return false;
                };

                // å•æ¡æäº¤ (ä¿æŒåŸé€»è¾‘)
                const submitBill = async () => {
                    if (!roomId.value) return ElMessage.warning('è¯·é€‰æ‹©æˆ¿é—´');
                    try {
                        const payload = { date: dateStr.value, roomName: roomId.value, sales: roomPrice.value };
                        if (isEdit.value) {
                            const res = await api.editBill({ ...payload, id: editId.value });
                            if (res.code === 200) ElMessage.success('ä¿®æ”¹æˆåŠŸ');
                            else ElMessage.error(res.message);
                        } else {
                            const res = await api.addBill(payload);
                            if (res.code === 200) ElMessage.success('è®°è´¦æˆåŠŸ');
                            else if (res.code === 409) ElMessage.error('è¯¥æˆ¿é—´ä»Šæ—¥å·²è®°è´¦');
                            else ElMessage.error(res.message);
                        }
                        isEdit.value = false; editId.value = null;
                        loadBills();
                    } catch (e) { ElMessage.error('æ“ä½œå¤±è´¥'); }
                };

                // --- æ–°å¢ï¼šæ‰¹é‡æäº¤é€»è¾‘ ---
                const openBatchDialog = () => {
                    showBatchDialog.value = true;
                    batchDates.value = [];
                    batchRange.value = [];
                };

                const submitBatch = async () => {
                    if (!roomId.value) return ElMessage.warning('è¯·é€‰æ‹©æˆ¿é—´');
                    if (batchCount.value === 0) return ElMessage.warning('è¯·é€‰æ‹©æ—¥æœŸ');

                    submitting.value = true;
                    let targetDates = [];

                    // 1. è®¡ç®—æ‰€æœ‰éœ€è¦è®°è´¦çš„æ—¥æœŸåˆ—è¡¨
                    if (batchMode.value === 'dates') {
                        targetDates = [...batchDates.value];
                    } else {
                        // èŒƒå›´æ¨¡å¼ï¼šç”Ÿæˆä¸­é—´æ‰€æœ‰æ—¥æœŸ
                        let current = dayjs(batchRange.value[0]);
                        const end = dayjs(batchRange.value[1]);
                        while (current.isBefore(end) || current.isSame(end, 'day')) {
                            targetDates.push(current.format('YYYY-MM-DD'));
                            current = current.add(1, 'day');
                        }
                    }

                    try {
                        let successCount = 0;
                        // 2. å¹¶å‘è¯·æ±‚
                        const promises = targetDates.map(date => {
                            return api.addBill({ date: date, roomName: roomId.value, sales: roomPrice.value })
                                .then(res => {
                                    if (res.code === 200) successCount++;
                                    return res;
                                });
                        });

                        await Promise.all(promises);

                        if (successCount > 0) {
                            ElMessage.success(`æˆåŠŸè®°å…¥ ${successCount} ç¬”`);
                            showBatchDialog.value = false; // å…³é—­å¼¹çª—
                            loadBills(); // åˆ·æ–°å½“å‰é¡µé¢
                        } else {
                            ElMessage.warning('æœªèƒ½è®°å…¥ï¼Œå¯èƒ½é€‰ä¸­çš„æ—¥æœŸè¯¥æˆ¿é—´å·²æœ‰è´¦å•');
                        }
                    } catch (e) {
                        ElMessage.error('æ‰¹é‡æ“ä½œå¼‚å¸¸');
                    } finally {
                        submitting.value = false;
                    }
                };

                // å…¶ä»–è¾…åŠ©åŠŸèƒ½ä¿æŒä¸å˜
                const editBill = (row) => { isEdit.value = true; editId.value = row.id; roomId.value = row.roomName; roomPrice.value = row.sales; scrollToForm(); };
                const removeBill = async (id) => { try { const res = await api.deleteBill(id); if (res.code === 200) { ElMessage.success('å·²åˆ é™¤'); loadBills(); } } catch (e) { } };
                const handleRemove = (id) => {
                    ElMessageBox.confirm(
                        'ç¡®å®šè¦åˆ é™¤è¿™æ¡è´¦å•å—ï¼Ÿ',
                        'æç¤º',
                        {
                            confirmButtonText: 'ç¡®å®š',
                            cancelButtonText: 'å–æ¶ˆ',
                            type: 'warning'
                        }
                    )
                        .then(() => removeBill(id))   // ç”¨æˆ·ç‚¹äº†â€œç¡®å®šâ€
                        .catch(() => { })              // ç‚¹â€œå–æ¶ˆâ€æˆ–å…³é—­ï¼Œé™é»˜å¿½ç•¥
                }
                const cancelEdit = () => { isEdit.value = false; editId.value = null; roomPrice.value = 80; };

                const showRoomManager = ref(false);
                const newRoomName = ref('');
                const openRoomManager = () => { showRoomManager.value = true; loadRooms(); };
                const handleAddNewRoom = async () => { if (!newRoomName.value) return; try { const res = await api.addRoom(newRoomName.value); if (res.code === 200) { newRoomName.value = ''; loadRooms(); } else ElMessage.error(res.message); } catch (e) { } };
                const handleDeleteRoom = async (r) => { try { await api.deleteRoom(r.id); loadRooms(); } catch (e) { } };
                const scrollToForm = () => { document.getElementById('form-section')?.scrollIntoView({ behavior: 'smooth' }); };

                onMounted(() => { loadRooms(); loadBills(); });

                return {
                    selectedDate, bills, roomList, roomId, roomPrice, isEdit, dateStr, todayStr,
                    showRoomManager, newRoomName, Plus, Setting, Files,
                    loadBills, submitBill, editBill, cancelEdit, removeBill,handleRemove,
                    openRoomManager, handleAddNewRoom, handleDeleteRoom, hasBill, scrollToForm, handleDateChange,
                    // æ‰¹é‡ç›¸å…³å¯¼å‡º
                    showBatchDialog, openBatchDialog, submitBatch, batchMode, batchDates, batchRange, batchCount, submitting
                };
            }
        });

        // --- Analysis å’Œ Mine ç»„ä»¶ä¿æŒåŸé€»è¾‘ ---
        const Analysis = defineComponent({
            template: '#tmpl-analysis',
            setup() {
                const totalSales = ref(0); const roomSales = ref([]); const roomSalesCount = ref([]);
                const selectedMonth = ref(dayjs().format('YYYY-MM'));
                const daysInMonth = computed(() => dayjs(selectedMonth.value).daysInMonth());
                const loadData = async () => {
                    if (!selectedMonth.value) return;
                    try {
                        const [t, r, c] = await Promise.all([api.getMonthTotalSales(selectedMonth.value), api.getMonthEveryTotalSales(selectedMonth.value), api.getSalesInMonth(selectedMonth.value)]);
                        totalSales.value = t.data || 0; roomSales.value = r.data || []; roomSalesCount.value = c.data || [];
                    } catch (e) { }
                };
                const getProgressPercentage = (cnt) => Math.round((cnt / daysInMonth.value) * 100);
                const getProgressColor = (cnt) => { const p = cnt / daysInMonth.value; return p >= 0.8 ? '#10b981' : p >= 0.5 ? '#f59e0b' : '#ef4444'; };
                onMounted(loadData);
                return { totalSales, roomSales, roomSalesCount, selectedMonth, daysInMonth, loadData, getProgressPercentage, getProgressColor, Money };
            }
        });

        // --- Mine Component (æˆ‘çš„) ---
        const Mine = defineComponent({
            template: '#tmpl-mine',
            setup() {
                const monthlyOrders = ref([]);
                const monthTotalSales = ref(0);
                // æ–°å¢ï¼šé€‰ä¸­æœˆä»½ï¼Œé»˜è®¤ä¸ºå½“å‰æœˆ
                const selectedMonth = ref(dayjs().format('YYYY-MM'));
                const router = useRouter();

                const load = async () => {
                    const ym = selectedMonth.value;
                    try {
                        // å¹¶è¡Œè¯·æ±‚ï¼šæ‰€æœ‰è´¦å• + å½“æœˆæ€»é¢
                        const [o, t] = await Promise.all([
                            api.selectAllBills(),
                            api.getMonthTotalSales(ym)
                        ]);

                        // 1. å¤„ç†æ€»é¢
                        monthTotalSales.value = t.data || 0;

                        // 2. å¤„ç†åˆ—è¡¨ï¼šå‰ç«¯è¿‡æ»¤å‡ºå½“å‰é€‰ä¸­æœˆä»½çš„æ•°æ®
                        const allBills = o.data || [];

                        // è¿‡æ»¤é€»è¾‘ï¼šä¿ç•™ date å­—æ®µä»¥ "YYYY-MM" å¼€å¤´çš„è®°å½•
                        const filteredBills = allBills.filter(bill => {
                            return bill.date && bill.date.startsWith(ym);
                        });

                        // æ’åºé€»è¾‘ï¼šæŒ‰æ—¥æœŸé™åºæ’åˆ— (æœ€æ–°çš„åœ¨æœ€ä¸Šé¢)
                        filteredBills.sort((a, b) => new Date(b.date) - new Date(a.date));

                        monthlyOrders.value = filteredBills;

                    } catch (e) {
                        console.error("åŠ è½½å¤±è´¥", e);
                        // å³ä½¿å¤±è´¥ä¹Ÿè¦æ¸…ç©ºæ•°æ®ï¼Œé˜²æ­¢æ˜¾ç¤ºé”™è¯¯çš„æ—§æ•°æ®
                        monthlyOrders.value = [];
                        monthTotalSales.value = 0;
                    }
                };

                const logout = () => {
                    localStorage.clear();
                    router.replace('/login');
                }

                // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
                onMounted(load);

                return {
                    monthlyOrders,
                    monthTotalSales,
                    selectedMonth, // å¯¼å‡ºç»™æ¨¡æ¿ä½¿ç”¨
                    load,          // å¯¼å‡ºç»™æ—¥æœŸé€‰æ‹©å™¨ change äº‹ä»¶ä½¿ç”¨
                    Wallet,
                    logout
                };
            }
        });

        const App = defineComponent({
            setup() {
                const route = useRoute(); const router = useRouter();
                const tabs = [{ key: 'home', title: 'è®°è´¦', icon: 'Calendar' }, { key: 'analysis', title: 'ç»Ÿè®¡', icon: 'DataLine' }, { key: 'mine', title: 'æˆ‘çš„', icon: 'User' }];
                const activeTab = computed(() => route.name || 'home');
                const showTabBar = computed(() => route.name !== 'login');
                const switchTab = (t) => router.push({ name: t.key });
                return { tabs, activeTab, switchTab, showTabBar };
            }
        });

        const router = createRouter({
            history: createWebHashHistory(),
            routes: [{ path: '/login', name: 'login', component: LoginComponent }, { path: '/', name: 'home', component: OrderBook }, { path: '/analysis', name: 'analysis', component: Analysis }, { path: '/mine', name: 'mine', component: Mine }]
        });
        router.beforeEach((to, from, next) => {
            const token = nativeStorage.getItem('token');
            if (['login'].includes(to.name)) { if (token) return next({ path: '/' }); return next(); }
            if (!token) return next({ name: 'login' });
            next();
        });

        const app = createApp(App);
        for (const [k, v] of Object.entries(ElementPlusIconsVue)) app.component(k, v);
        app.use(ElementPlus, { locale: ElementPlusLocaleZhCn });
        app.use(router);
        app.mount('#app');
    </script>
</body>

</html>